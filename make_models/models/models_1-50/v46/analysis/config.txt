
from pathlib import Path
import numpy as np

# ============================================================
# ğŸŒ 1. PROJECT PATHS
# ============================================================
ROOT_DIR = Path(__file__).resolve().parent.parent
DATA_DIR = ROOT_DIR / "data"
TRACKS_DIR = ROOT_DIR / "tracks"
MODELS_DIR = ROOT_DIR /"make_models"/ "models"
LOGS_DIR = ROOT_DIR / "logs"
CACHE_SUBDIR = "cache"
CACHE_DIR = DATA_DIR / CACHE_SUBDIR

LATEST_MODEL_NAME = "latest.h5"

# ×™×¦×™×¨×ª ×ª×™×§×™×•×ª ×‘××™×“×” ×•×œ× ×§×™×™××•×ª
for p in [DATA_DIR, MODELS_DIR, CACHE_DIR, LOGS_DIR]:
    p.mkdir(parents=True, exist_ok=True)

# ============================================================
# ğŸ¼ 2. AUDIO PROCESSING
# ============================================================
SR = 22050                          # Sampling Rate
SEGMENT_SECONDS = 30               # ××•×¨×š ×›×œ ××§×˜×¢
WINDOW_STRIDE_SECONDS = 1          # ×›×¨×’×¢ ×œ×œ× overlapping
SEGMENT_POSITIONS = [0.1, 0.25, 0.40, 0.60, 0.75, 0.9]
NUM_SEGMENTS = len(SEGMENT_POSITIONS)
MIN_TRACK_DURATION_SEC = 5 * 60
MAX_TRACK_DURATION_SEC = 15 * 60
CHECK_SILENCE = True
ENERGY_THRESHOLD = 0.005

# ============================================================
# ğŸ¹ 3. FEATURE EXTRACTION â€” ×œ×•×’×™×§×” ×—×›××” ×•×“×™× ×××™×ª
# ============================================================

# ××¡×¤×¨ ×”×—×œ×•× ×•×ª ×‘×§×˜×¢ = ×–××Ÿ ×—×œ×§ / ×–××Ÿ ×—×œ×•×Ÿ
WINDOWS_PER_SEGMENT = SEGMENT_SECONDS // WINDOW_STRIDE_SECONDS

# 3.2 ×”×’×“×¨×ª ×¤×™×¦'×¨×™× ×©××•×¤×§×™× ××›×œ ×—×œ×•×Ÿ
FEATURES_CONFIG = {
    "MFCC": 13,
    "SPECTRAL": ["centroid", "bandwidth", "rolloff"],  # 3
    "CONTRAST": False,                # 7
    "CHROMA": True,                  # 12
    "FLATNESS": False,                # 1
    "STD": True,                     # 1
    "DIFF": False,                    # 1
    "BPM": True                      # 1
}

def compute_features_per_window():
    total = 0
    # MFCC mean + var
    if "MFCC" in FEATURES_CONFIG:
        total += FEATURES_CONFIG["MFCC"] * 2

    # spectral ×‘×¡×™×¡×™×™×
    if "SPECTRAL" in FEATURES_CONFIG:
        total += len(FEATURES_CONFIG["SPECTRAL"])

    # ×©××¨ ×”×¤×™×¦â€™×¨×™× ×œ×¤×™ True
    total += 7  if FEATURES_CONFIG.get("CONTRAST", False) else 0
    total += 12 if FEATURES_CONFIG.get("CHROMA", False) else 0
    total += 1  if FEATURES_CONFIG.get("FLATNESS", False) else 0
    total += 1  if FEATURES_CONFIG.get("STD", False) else 0
    total += 1  if FEATURES_CONFIG.get("DIFF", False) else 0
    total += 1  if FEATURES_CONFIG.get("BPM", False) else 0
    return total

FEATURES_PER_WINDOW = compute_features_per_window()
EMB_SHAPE = (WINDOWS_PER_SEGMENT, FEATURES_PER_WINDOW)

# 3.4 ×¢×™×‘×•×“×™× ××¤×©×¨×™×™×
USE_EMBEDDING = True
NORMALIZE_EMBEDDING = True
APPLY_PCA_EMBEDDING = False
EMBEDDING_POOLING = "flatten"     # ××¤×©×¨ ×’× "mean" / "max"

# =============================================================================
# ğŸ“Š 4. META FEATURES
# =============================================================================
USE_META = True
META_SCALE = 0.01
META_FEATURE_NAMES = ["BPM", "Key", "Energy", "Flatness"]
META_VECTOR_LENGTH = len(META_FEATURE_NAMES)
META_SCALER_TYPE = "standard"      # "standard" | "minmax" | None
# ============================================================
# ğŸ§  5. MODEL ARCHITECTURE
# ============================================================

VALID_GENRES = ["goa", "psy", "dark"]
NUM_GENRES = len(VALID_GENRES)

# ------------------------------------------------------------
# ğŸ”¹ ×‘×—×™×¨×ª ×¡×•×’ ×”××•×“×œ ×œ×—×œ×§ ×”Ö¾Embedding
# ------------------------------------------------------------
# ××¤×©×¨×•×™×•×ª:
#   "dense"       â†’ Fully Connected
#   "gru"         â†’ ×¨×¦×£ (×˜×•×‘ ×œ×–××Ÿ)
#   "transformer" â†’ ××ª×§×“×
#   "crnn"        â†’ Convolution + GRU (×©×™×œ×•×‘ ××¢×•×œ×” ×œ××•×“×™×•)
#   "conformer"   â†’ ××©×•×œ×‘ Conv + Attention (state-of-the-art ×‘××•×“×™×•)
EMBEDDING_MODEL_TYPE = "transformer"

# ------------------------------------------------------------
# ğŸ“Œ ×¤×¨××˜×¨×™× ×œ×¤×™ ×”××•×“×œ ×”× ×‘×—×¨
# ------------------------------------------------------------

# ğŸŸ© Dense (×¤×©×•×˜)
DENSE_EMB_CONFIG = {
    "layer_1": 128,
    "layer_2": 64,
    "dropout": 0.05
}

# ğŸŸ¨ GRU ×‘×œ×‘×“
GRU_CONFIG = {
    "units": 64,
    "dropout": 0.05,
    "bidirectional": True
}

# ğŸŸ¥ CRNN - ×©×™×œ×•×‘ Conv1D + GRU
CRNN_CONFIG = {
    # CNN
    "conv_filters": 64,
    "kernel_size": 3,
    "conv_dropout": 0.10,

    # GRU ××—×¨×™ ×§×•× ×‘×•×œ×•×¦×™×”
    "gru_units": 64,
    "gru_dropout": 0.05,
    "bidirectional": True
}

# ğŸŸ¦ Transformer
TRANSFORMER_CONFIG = {
    "d_model": 64,
    "num_heads": 4,
    "num_layers": 4,
    "dropout": 0.1
}

# ğŸŸª Conformer (××•××œ×¥ ×œ××•×“×™×•)
CONFORMER_CONFIG = {
    "d_model": 64,          # ×’×•×“×œ Hidden
    "num_heads": 4,         # ×›××• Transformer
    "num_layers": 2,        # ×›××” ×‘×œ×•×§×™× ×©×œ Conformer
    "conv_kernel_size": 3,  # ×§×•× ×‘×•×œ×•×¦×™×” ××§×•××™×ª
    "dropout": 0.1
}


# ------------------------------------------------------------
# ğŸ”¸ Meta Branch
# ------------------------------------------------------------
META_CONFIG = {
    "use": True,
    "units": 8,
    "activation": "relu"
}

# ------------------------------------------------------------
# ğŸ”» Combined head
# ------------------------------------------------------------
COMBINED_HEAD_CONFIG = {
    "dense_1": 128,
    "dense_2": 64,
    "dropout": 0.40,
    "activation": "relu",
    "combine_mode": "concat",  # "concat" | "add" | "attention"
    "use_attention": False
}


# ============================================================
# ğŸ“ˆ 6. TRAINING
# ============================================================
EPOCHS = 20
BATCH_SIZE = 32
VAL_SPLIT = 0.20
SHUFFLE_DATA = True

INIT_LR = 1e-4
MIN_LR = 1e-6
WARMUP_EPOCHS = 3
LABEL_SMOOTHING = 0.05
EARLY_STOP_PATIENCE = 4
CLASS_WEIGHT_MODE = "balanced"

SEED = 42
np.random.seed(SEED)

# ============================================================
# ğŸ” 7. ANALYSIS
# ============================================================
ENABLE_CONFUSION_MATRIX = True
ENABLE_TRAIN_PLOTS = True
ENABLE_GRADIENT_SENSITIVITY = True
ENABLE_INTEGRATED_GRADIENTS = True
IG_STEPS = 24
GRADIENT_SAMPLES = 64

SAVE_REPORT = True
SAVE_INPUT_IMPORTANCE = True
SAVE_TIME_PER_EPOCH = True
